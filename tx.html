<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Encrypted Transactions - Ferveo</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="prefix.html">Introduction</a></li><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="preliminaries.html"><strong aria-hidden="true">2.</strong> Preliminaries</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="assumptions.html"><strong aria-hidden="true">2.1.</strong> System model and assumptions</a></li><li class="chapter-item expanded "><a href="primitives.html"><strong aria-hidden="true">2.2.</strong> Cryptographic Primitives</a></li></ol></li><li class="chapter-item expanded "><a href="dkg.html"><strong aria-hidden="true">3.</strong> Publicly Verifiable Distributed Key Generation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="dkginit.html"><strong aria-hidden="true">3.1.</strong> Initialization</a></li><li class="chapter-item expanded "><a href="pvss.html"><strong aria-hidden="true">3.2.</strong> Publicly Verifiable Secret Sharing</a></li></ol></li><li class="chapter-item expanded "><a href="tpke.html"><strong aria-hidden="true">4.</strong> Threshold Encryption Scheme</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lagrange.html"><strong aria-hidden="true">4.1.</strong> Lagrange Interpolation</a></li><li class="chapter-item expanded "><a href="aggregation.html"><strong aria-hidden="true">4.2.</strong> Decryption Share Aggregation</a></li><li class="chapter-item expanded "><a href="tpke-concrete.html"><strong aria-hidden="true">4.3.</strong> Complete Concrete Scheme</a></li><li class="chapter-item expanded "><a href="performance.html"><strong aria-hidden="true">4.4.</strong> Performance</a></li></ol></li><li class="chapter-item expanded "><a href="tx.html" class="active"><strong aria-hidden="true">5.</strong> Encrypted Transactions</a></li><li class="chapter-item expanded affix "><li class="part-title">Appendix</li><li class="chapter-item expanded "><a href="sca.html"><strong aria-hidden="true">6.</strong> Side Channel Analysis</a></li><li class="chapter-item expanded "><a href="tss.html"><strong aria-hidden="true">7.</strong> Threshold Signature Scheme</a></li><li class="chapter-item expanded "><a href="keyrefresh.html"><strong aria-hidden="true">8.</strong> Key Refresh</a></li><li class="chapter-item expanded "><a href="enclave.html"><strong aria-hidden="true">9.</strong> Secure enclave computation</a></li><li class="chapter-item expanded "><a href="alternative.html"><strong aria-hidden="true">10.</strong> Alternative Schemes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="pedersen.html"><strong aria-hidden="true">10.1.</strong> Pedersen DKG</a></li><li class="chapter-item expanded "><a href="fastkzg.html"><strong aria-hidden="true">10.2.</strong> Fast KZG DKG</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tpke-kzg-dkg.html"><strong aria-hidden="true">10.2.1.</strong> Threshold Encryption</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Ferveo</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#encrypted-transactions" id="encrypted-transactions">Encrypted Transactions</a></h1>
<p>When Ferveo is integrated into Tendermint, the validators should run the DKG once per epoch and the generated public key \(Y\) broadcast to all nodes in the network.</p>
<p>Transactions sent to the mempool should be encrypted to this public key, and block proposers select encrypted transactions from the mempool and commit to them in to block proposals. Therefore, the execution and ordering of transactions is determined before they are decrypted and revealed.</p>
<p>An encrypted transaction consists of:</p>
<ul>
<li>The public key ciphertext \(U, W\) associated with this transaction</li>
<li>The key-committing AEAD encrypted payload of the transaction, with symmetric key derived from \(U, W\)</li>
<li>Transaction fee payment details</li>
<li>The epoch number that the tx is being encrypted to. </li>
</ul>
<p>The inclusion of fee payment outside of the payload ensures that the network is not saturated with invalid transactions.</p>
<p>The encryption method is then ran roughly as:</p>
<ol>
<li>Sample private key <code>k</code>.</li>
<li>Compute Ciphertext as <code>CT = KC_AEAD.Encrypt(key=Hash(k * threshold_pubkey), msg={state machine tx}, additional_data={empty})</code></li>
<li>Run Threshold Encryption as <code>TE.Encrypt(private_key=k, threshold_pubkey, ciphertext=ct, additional_data={tx fee details, epoch number})</code></li>
</ol>
<h2><a class="header" href="#block-proposal" id="block-proposal">Block proposal</a></h2>
<p>A block proposal, therefore, consists of:</p>
<ol>
<li>Validator-selected encrypted transactions (likely ordered by fee)</li>
<li>Decryption data for all transactions in the previous block</li>
</ol>
<p>Availability of decryption shares for those transactions is guaranteed by new block finalization rules, and it is the block proposer's responsibility to combine the decryption shares to derive each transaction's symmetric key, and to compute the AEAD decryption of each encrypted transaction's payload.</p>
<p>The decryption data for a tx is oneof (<code>encryption_private_key</code>, <code>list of decryption shares</code>). For a validly constructed transaction, the decryption shares can be combined to get the symmetric key. The combined share can then be included within the block, and every node can check its validity by correctness of the key-committing AEAD.</p>
<p>If the tx was invalidly constructed, then all of the constituent decryption shares must get posted on-chain for verifyability.**</p>
<p>Constructing a valid block proposal therefore executes 1 <code>TPKE.CombineDecryptionShares</code> operation per transaction per block signer in the previous block.</p>
<p>Verifying the validity of a block proposal therefore executes 1 <code>TPKE.VerifyCombination</code> operation per block signer in the previous block. </p>
<p>** There is an optimization where we only need one list of 'cross-tx combined' decryption shares, for all invalid txs per block.</p>
<h2><a class="header" href="#block-finalization" id="block-finalization">Block finalization</a></h2>
<p>In addition to the standard 2/3 weight requirements for block finalization, Ferveo adds an additional requirement: every validator signature on a block must include valid, signed decryption shares corresponsing to that validator, for every encrypted transaction committed to in that block, totaling at least 2/3 weight of decryption shares. </p>
<p>Signing a block proposal therefore executes 1 <code>TPKE.CiphertextValidity </code> operation and 1 <code>TPKE.CreateDecryptionShare()</code> operation per transaction in that block proposal.</p>
<p>Verifying the block proposal executes 1 <code>TPKE.CiphertextValidity </code> operation and 1 <code>TPKE.BatchVerifyDecryptionShares()</code> operation per transaction in that block proposal.</p>
<p>This guarantees liveness will be similar: the network will not stop while waiting for decryption shares unless the network stops while waiting for signatures as well.</p>
<h2><a class="header" href="#invalid-transactions" id="invalid-transactions">Invalid transactions</a></h2>
<p>The primary issue in accepting the finality of a block is verification that the decryption of every transaction succeeded correctly. </p>
<p>In the optimistic case, where all transactions are constructed exactly as required by the protocol, the block proposer can run <code>TPKE.CombineDecryptionShares()</code> to obtain the shared secret, and therefore the 256 bit symmetric key, for each transaction. Since all transactions are valid, this symmetric key successfully decrypts the transaction plaintext which matches the BLAKE2b hash. (Alternatively, a key-committing scheme could be used). Therefore, only one 32 byte symmetric key per transaction needs to be added to the block, to assist in block verification.</p>
<p>Problems arise when an invalid transaction, where either the symmetric key or BLAKE2b hash, does not match the transaction payload. The protocol must verify that the transaction is actually invalid and that no validator submitted invalid decryption shares or failed to combine shares according to protocol. Otherwise, a malicious validator would be able to deny execution of specific transactions upon discovering its contents. </p>
<p>To avoid a high cost incurrec (and DoS attack vector) of many invalid transactions, all invalid transactions are handled in an aggregated way. The decryption shares of all invalid transactions are aggregated using <code>TPKE.AggregateDecryptionShares</code>; the aggregated decryption shares, along with the result of <code>TPKE.CombineDecryptionShares</code>
for each invalid transaction, is attached to the block instead of the 32 byte symmetric key. </p>
<p>Therefore, full nodes can run the relatively inexpensive <code>TPKE.VerifyAggregatedCombination</code> to check the validity of the combined shares of each allegedly invalid transaction, and attempt symmetric decryption using each transaction's derived symmetric key. Upon the expected failure to decrypt an invalid transaction, that transaction is discarded instead of executed (consuming any fee) which mitigates the minor additional cost of invalidity verification. </p>
<h3><a class="header" href="#correctness-of-decryption-shares" id="correctness-of-decryption-shares">Correctness of decryption shares</a></h3>
<p>The validity of all decryption shares must be checked before accepting a block. </p>
<p>In case <code>TPKE.BatchVerifyDecryptionShares</code> fails, indicating that some validator may have sent faulty decryption shares, a fallback protocol must be initiated to discover which validators sent valid decryption shares, by executing <code>TPKE.VerifyDecryptionShares</code> separately for each validator's decryption shares. </p>
<p>This is significantly more expensive than <code>TPKE.BatchVerifyDecryptionShares</code>; however, since penalties can be enforced on validators for sending bad decryption shares, the optimistic verification <code>TPKE.BatchVerifyDecryptionShares</code> should succeed most of the time.</p>
<h2><a class="header" href="#privacy" id="privacy">Privacy</a></h2>
<p>Ferveo only provides additional privacy while pending <strong>within the mempool</strong>; once transactions are decrypted, all details of the payload become public. In addition, fee payment information reveals who the fee payer is (who may be a proxy).</p>
<h2><a class="header" href="#invalid-transactions-1" id="invalid-transactions-1">Invalid transactions</a></h2>
<p>In the case where the transaction creator does not follow the protocol, for example by having an invalid payload, a payload that does not match the hash, or using a bad nonce \(r\), the network does not make any guarantees regarding privacy or execution order (or execution at all) of an invalid transaction.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="performance.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="sca.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="performance.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="sca.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
